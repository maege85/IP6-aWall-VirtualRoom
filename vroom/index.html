<!DOCTYPE html>
<html>
	<head>
		<title>Webrtc App</title>
		<meta charset="UTF-8">
			<meta name="viewport" content="width=device-width, initial-scale=1.0">
				<script src="https://code.jquery.com/jquery-latest.min.js"></script>
				<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
				<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
				<link rel="stylesheet" type="text/css" href="vroom-style.css">
				</head>
				<body>

					<div id="message"> </div>
					<div id="loginElements">
			username:	  <input type="text" id="usernameInput"/>
						<input type="button" id="loginButton" onclick="login()" value="Login"/>
					</div>
					<div id="roomElements" style="display: none;">

		  <div id="memberList"></div> <input type="button" id="enterRoomButton" onclick="enterRoom()" value="Enter Room"/>
		  <input type="button" id="logoutButton" onclick="logout()" value="Logout"/>
					</div>

					<div id="videoElements" style="display: none;">
			  <div id="memberList2"></div>
						<div id="waiting">Waiting for peer to enter room...</div>
						<input type="button" id="disconnectButton" onclick="hangup()" value="Han Up""/></br>
					<video id="localVideo"  autoplay controls class="localVideo"></video>        
					<video id="remoteVideo" autoplay controls class="remoteVideo"></video>     

				</div>   
			</body>
		</html>
		<script type="text/javascript">




    'use strict';

    var isChannelReady = false;
    var isInitiator = false;
    var isStarted = false;
    var localStream;
    var pc;
    var remoteStream;
    var turnReady;
    var pc_config = {'iceServers': [{'url': 'stun:45.79.136.43:3478'}]}; // make this stun server on our droplet...
    var sdpConstraints = {'mandatory': {'OfferToReceiveAudio':true, 'OfferToReceiveVideo':true}};
    var localVideo;
    var remoteVideo;
	var user;
	var isLoggedIn = false;
	const ROOM_NAME ="Room1";
	
	
    window.RTCPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
    window.RTCIceCandidate = window.RTCIceCandidate || window.mozRTCIceCandidate || window.webkitRTCIceCandidate;
    window.RTCSessionDescription = window.RTCSessionDescription || window.mozRTCSessionDescription || window.webkitRTCSessionDescription;
    window.navigator.getUserMedia = window.navigator.getUserMedia || window.navigator.mozGetUserMedia || window.navigator.webkitGetUserMedia;
    window.URL = window.URL || window.mozURL || window.webkitURL;

    var socket = io.connect('https://server1095.cs.technik.fhnw.ch', {path: '/vroom/socket.io'});

	socket.on('has-loged-in', function (roomList) {
		if(roomList.hasOwnProperty(ROOM_NAME)){
			setRoomMembers(roomList[ROOM_NAME].members);
			setRoomToFull(roomList[ROOM_NAME].isFull);
		}
		else{
			setRoomMembers("No one there");
		}
		showRoomElements();
	});




    socket.on('created', function (roomInfos) {
		isInitiator = true;
        console.log('Created room ' + roomInfos.roomName);
		console.log('members ' + roomInfos.members.toString());
		isInitiator = true;
		setRoomMembers(roomInfos.members);
		prepareVideo();

    });

    socket.on('full', function (roomInfos) {
		setRoomToFull(roomInfos.isFull);
    });

	socket.on('join', function (roomInfos) {
        console.log('Another peer joined room ' + roomInfos.roomName);
		setRoomMembers(roomInfos.members);
		$('#waiting').hide();
        console.log('This peer is the initiator of room ' + roomInfos.roomName + '!');
        isChannelReady = true;
    });
    socket.on('joined', function (roomInfos) {
        console.log('This peer has joined room ' + roomInfos.roomName);
		setRoomMembers(roomInfos.members);
		prepareVideo();
		$('#waiting').hide();
		isChannelReady = true;

    });

	socket.on('log', function (message){
	  console.log(message);
	});

	 socket.on('message', function (message) {
        console.log('Client received message:', message);
        if (message === 'got user media') {
            maybeStart();
        } else if (message.type === 'offer') {
		if(isChannelReady){
            if (!isInitiator && !isStarted) {
                maybeStart();
            }
            pc.setRemoteDescription(new RTCSessionDescription(message));
            doAnswer();
			}
        } else if (message.type === 'answer' && isStarted) {
            pc.setRemoteDescription(new RTCSessionDescription(message));
        } else if (message.type === 'candidate' && isStarted) {
            var candidate = new RTCIceCandidate({candidate: message.candidate});
            pc.addIceCandidate(candidate);
        } else if (message === 'bye') {
			resetVideo();
        }
    });


	
	////////////////////////////////////////////////////

	function login(){
	var user = $("#usernameInput").val();
		console.log('send login user ' + user);
	socket.emit('login', user);
	isLoggedIn = true;
	}
	////////////////////////////////////////////////////
	
	function logout(){
		console.log('logout');
		socket.emit('logout', user);
		isLoggedIn = false;
		resetVideo();
	
	}
	

	////////////////////////////////////////////////////
	function enterRoom(){
		user = $("#usernameInput").val();
		var data = {room:ROOM_NAME, user:user}; 
			console.log('send create_or_join', data);
			socket.emit('create_join', data);
	}
	
	////////////////////////////////////////////////////
	function hangup(){
	console.log('hangup');
	socket.emit('hangup', user);
	resetVideo();
	}

	///////////////////////////////////////////////////
	function prepareVideo(){
		showVideoElements();
		localVideo = document.querySelector('#localVideo');
		remoteVideo = document.querySelector('#remoteVideo');
		var constraints = {audio: true, video: true};
		navigator.getUserMedia(constraints, handleUserMedia, handleUserMediaError);
		console.log('Getting user media with constraints', constraints);
	}
	
	///////////////////////////////////////////////////

	function resetVideo(){
		if(isLoggedIn){
			showRoomElements();
		}
		else{
			showLoginElements();
		}
		isChannelReady = false;
		setRoomToFull(false);
		setRoomMembers("");
		isInitiator = false;
		isStarted = false;
		localStream = 'undefined';
		if (typeof pc != "undefined" && pc != null){
			pc.close();
			pc = null;
		}
	}
	////////////////////////////////////////////////////

	function setRoomMembers(roomMembers){
		$('#memberList' ).html("<div>Members in Room1: " +roomMembers.toString() + "</div>");
		$('#memberList2' ).html("<div>Members in Room1: " +roomMembers.toString() + "</div>");
	}

	////////////////////////////////////////////////////

	function setRoomToFull(isFull){
	if(isFull){
	$("#enterRoomButton").prop("disabled",true);
		$('#message' ).html("<div>Room is full. You can not join</div>"); 
		}
		else{
		$('#message' ).html("");
		$("#enterRoomButton").prop("disabled",false);
		}

	}

	////////////////////////////////////////////////////

	function showRoomElements(){
	$('#roomElements').show();
		$('#videoElements').hide();
		$('#loginElements').hide();
	}
	
	function showLoginElements(){
	$('#roomElements').hide();
		$('#videoElements').hide();
		$('#loginElements').show();
	}
	function showVideoElements(){
	$('#roomElements').hide();
		$('#videoElements').show();
		$('#loginElements').hide();
	}
	
	

////////////////////////////////////////////////
    function sendMessage(message) {
        console.log('Client sending message: ', message);
        socket.emit('message', message);
    }

////////////////////////////////////////////////////

    function handleUserMedia(stream) {
        console.log('Adding local stream.');
        localVideo.muted="muted";
        localVideo.src = window.URL.createObjectURL(stream);
        localStream = stream;
        sendMessage('got user media');
        if (isInitiator) {
            maybeStart();
        }
    }
	////////////////////////////////////////////////////
    function handleUserMediaError(error) {
        console.log('navigator.getUserMedia error: ', error);
    }

	////////////////////////////////////////////////////
    function maybeStart() {
        if (!isStarted && typeof localStream != 'undefined' && isChannelReady) {
		console.log("maybestart");
            createPeerConnection();
            pc.addStream(localStream);
            isStarted = true;

            console.log('isInitiator', isInitiator);
            if (isInitiator) {
                doCall();
            }
        }
    }
	
	////////////////////////////////////////////////////
    window.onbeforeunload = function (e) {
        sendMessage('bye');
    }
/////////////////////////////////////////////////////////
    function createPeerConnection() {
        try {
            pc = new RTCPeerConnection(pc_config); // native to browser
            pc.onicecandidate = handleIceCandidate;
            pc.onaddstream = handleRemoteStreamAdded;
            pc.onremovestream = handleRemoteStreamRemoved;
            console.log('Created RTCPeerConnnection');
        } catch (e) {
            console.log('Failed to create PeerConnection, exception: ' + e.message);
            alert('Cannot create RTCPeerConnection object.');
            return;
        }
    }
	
	////////////////////////////////////////////////////
	
    function handleIceCandidate(event) {
        console.log('handleIceCandidate event: ', event);
        if (event.candidate) {
            sendMessage({
                type: 'candidate',
                candidate: event.candidate.candidate});
        } else {
            console.log('End of candidates.');
        }
    }
	
	////////////////////////////////////////////////////
	
    function handleCreateOfferError(event) {
        console.log('createOffer() error: ', event);
    }

	////////////////////////////////////////////////////
	
       function handleCreateAnswerError(event) {
        console.log('createAnswer() error: ', event);
    }
	////////////////////////////////////////////////////
	
    function doCall() {
        console.log('Sending offer to peer');
        pc.createOffer(setLocalAndSendMessage, handleCreateOfferError,sdpConstraints);
    }
	////////////////////////////////////////////////////
	
    function doAnswer() {
        console.log('Sending answer to peer.');
        pc.createAnswer(setLocalAndSendMessage, handleCreateAnswerError, sdpConstraints);
    }
	////////////////////////////////////////////////////
	
    function setLocalAndSendMessage(sessionDescription) {
        pc.setLocalDescription(sessionDescription);
        console.log('setLocalAndSendMessage sending message', sessionDescription);
        sendMessage(sessionDescription);
    }
	////////////////////////////////////////////////////
	
    function handleRemoteStreamAdded(event) {
        console.log('Remote stream added.');

            remoteVideo.src = window.URL.createObjectURL(event.stream);

        remoteStream = event.stream;
    }
	////////////////////////////////////////////////////
    function handleRemoteStreamRemoved(event) {
        console.log('Remote stream removed. Event: ', event);
    }



</script>